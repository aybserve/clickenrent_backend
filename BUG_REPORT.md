# Critical Bugs Found in Gateway and Auth-Service

## üî¥ CRITICAL BUG #1: JWT Library Version Mismatch

**Severity:** CRITICAL - System will not work

**Location:**
- Auth-Service: `pom.xml` line 80-95 (JJWT 0.11.5)
- Gateway: `pom.xml` line 37-53 (JJWT 0.12.5)

**Problem:**
The auth-service and gateway are using **different major versions** of the JJWT library with **incompatible APIs**:

**Auth-Service (0.11.5):**
```java
// Uses old API
Jwts.parserBuilder()
    .setSigningKey(getSigningKey())
    .build()
    .parseClaimsJws(token)
    
signWith(getSigningKey(), SignatureAlgorithm.HS256)
```

**Gateway (0.12.5):**
```java
// Uses new API
Jwts.parser()
    .verifyWith(getSigningKey())
    .build()
    .parseSignedClaims(token)
```

**Impact:**
- Tokens generated by auth-service cannot be validated by gateway
- API methods are completely different between versions

**Fix Required:**
Update auth-service to use JJWT 0.12.5 to match gateway.

---

## üî¥ CRITICAL BUG #2: Missing JWT Claims

**Severity:** CRITICAL - Will cause NullPointerException

**Location:**
- Auth-Service: `JwtService.java` lines 81-83
- Gateway: `JwtAuthenticationFilter.java` lines 52-54

**Problem:**
The gateway expects JWT tokens to contain:
- `userId` (Long)
- `email` (subject)
- `roles` (List<String>)

But auth-service generates tokens with **ONLY**:
- `subject` (username) - not email!
- **No `userId` claim**
- **No `roles` claim**

**Auth-Service Code:**
```java
public String generateToken(UserDetails userDetails) {
    Map<String, Object> claims = new HashMap<>();  // ‚ùå Empty claims!
    return createToken(claims, userDetails.getUsername(), expiration);
}
```

**Gateway Code (expecting these claims):**
```java
Long userId = jwtUtil.extractUserId(token);        // ‚ùå Will return null
String email = jwtUtil.extractEmail(token);        // ‚ùå Gets username, not email
List<String> roles = jwtUtil.extractRoles(token);  // ‚ùå Will return null
```

**Impact:**
- `NullPointerException` when accessing `userId` in line 58 of JwtAuthenticationFilter
- `X-User-Id` header will be "null"
- `X-User-Roles` header will be empty
- Downstream services won't have user information

**Fix Required:**
Auth-service must add userId, email, and roles to JWT claims when generating tokens.

---

## üî¥ CRITICAL BUG #3: JWT Secret Key Encoding Mismatch

**Severity:** CRITICAL - Tokens cannot be validated

**Location:**
- Auth-Service: `JwtService.java` line 126
- Gateway: `JwtUtil.java` line 27

**Problem:**
The two services encode the JWT secret differently:

**Auth-Service:**
```java
private Key getSigningKey() {
    byte[] keyBytes = Decoders.BASE64.decode(secret);  // BASE64 decoding
    return Keys.hmacShaKeyFor(keyBytes);
}
```

**Gateway:**
```java
private SecretKey getSigningKey() {
    byte[] keyBytes = secret.getBytes(StandardCharsets.UTF_8);  // UTF-8 encoding
    return Keys.hmacShaKeyFor(keyBytes);
}
```

**Impact:**
- Auth-service treats the secret as BASE64-encoded
- Gateway treats the secret as plain UTF-8 text
- **Tokens signed by auth-service will FAIL validation in gateway**
- All protected routes will return 401 Unauthorized

**Fix Required:**
Both services must use the SAME encoding method (preferably BASE64 for security).

---

## üü° MODERATE BUG #4: Subject Contains Username Instead of Email

**Severity:** MODERATE - Data inconsistency

**Location:**
- Auth-Service: `JwtService.java` line 107
- Gateway: `JwtUtil.java` line 66

**Problem:**
Auth-service sets JWT subject to `username`:
```java
.setSubject(subject)  // subject = userDetails.getUsername()
```

Gateway expects subject to be `email`:
```java
public String extractEmail(String token) {
    return extractClaim(token, Claims::getSubject);  // Expects email
}
```

**Impact:**
- Gateway will extract username and label it as "email"
- Downstream services will receive wrong data in `X-User-Email` header
- Could cause issues if services rely on actual email format

**Fix Required:**
Auth-service should either:
1. Set subject to email address, OR
2. Gateway should extract username and rename the header

---

## üü° MODERATE BUG #5: Missing Build Configuration in Auth-Service

**Severity:** MODERATE - Build inconsistency

**Location:** Auth-Service `pom.xml`

**Problem:**
Auth-service is missing the `<build>` section with:
- Lombok annotation processor configuration
- Spring Boot Maven plugin configuration

**Impact:**
- May have Lombok compilation issues
- Inconsistent with gateway configuration
- Potential issues when building JAR file

**Fix Required:**
Add build section to auth-service pom.xml matching gateway configuration.

---

## üü¢ MINOR BUG #6: Route Order Issue in Gateway

**Severity:** MINOR - Could cause unexpected behavior

**Location:** Gateway `GatewayConfig.java` lines 53-56

**Problem:**
The fallback route `/api/auth/**` with JWT filter comes AFTER specific routes.

**Current Order:**
1. `/api/auth/register` (public)
2. `/api/auth/login` (public)
3. `/api/auth/refresh` (public)
4. `/api/auth/users/**` (protected)
5. `/api/auth/companies/**` (protected)
6. `/api/auth/profile/**` (protected)
7. `/api/auth/**` (fallback - protected) ‚Üê This catches everything else

**Impact:**
- Any new auth endpoints will default to requiring JWT
- Could be intentional, but should be documented
- May want public endpoints to be last instead

**Fix Required:**
Consider reordering or documenting the fallback behavior.

---

## Summary

| Bug | Severity | Will System Work? | Fix Priority |
|-----|----------|-------------------|--------------|
| JWT version mismatch | CRITICAL | ‚ùå NO | üî¥ IMMEDIATE |
| Missing JWT claims | CRITICAL | ‚ùå NO | üî¥ IMMEDIATE |
| Key encoding mismatch | CRITICAL | ‚ùå NO | üî¥ IMMEDIATE |
| Subject contains username | MODERATE | ‚ö†Ô∏è PARTIAL | üü° HIGH |
| Missing build config | MODERATE | ‚ö†Ô∏è YES | üü° MEDIUM |
| Route order | MINOR | ‚úÖ YES | üü¢ LOW |

## Recommended Fix Order

1. **Fix JWT version** - Update auth-service to JJWT 0.12.5
2. **Fix key encoding** - Standardize on BASE64 decoding
3. **Add JWT claims** - Include userId, email, roles in tokens
4. **Fix subject field** - Use email instead of username
5. **Add build config** - Add Lombok processor to auth-service
6. **Review routes** - Document fallback behavior

## Testing After Fixes

After fixing these bugs, test:
1. Login via gateway ‚Üí should get valid token
2. Access protected endpoint with token ‚Üí should succeed
3. Check logs for userId, email, roles extraction
4. Verify X-User-* headers are populated correctly
5. Test with invalid/expired tokens ‚Üí should return 401

---

**Generated:** 2025-11-28  
**Status:** Critical bugs prevent system from functioning

