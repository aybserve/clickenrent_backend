name: CI/CD Pipeline

on:
  push:
    branches: [ features/ci-cd ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    name: Build & Deploy to Production
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build all services (skip tests)
        run: mvn clean package -DskipTests -B
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: Build and push Gateway
        uses: docker/build-push-action@v5
        with:
          context: ./gateway
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/gateway:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Eureka Server
        uses: docker/build-push-action@v5
        with:
          context: ./eureka-server
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/eureka-server:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/eureka-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: ./auth-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Rental Service
        uses: docker/build-push-action@v5
        with:
          context: ./rental-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/rental-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/rental-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Payment Service
        uses: docker/build-push-action@v5
        with:
          context: ./payment-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/payment-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/payment-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Support Service
        uses: docker/build-push-action@v5
        with:
          context: ./support-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/support-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/support-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Notification Service
        uses: docker/build-push-action@v5
        with:
          context: ./notification-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Search Service
        uses: docker/build-push-action@v5
        with:
          context: ./search-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/search-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/search-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Analytics Service
        uses: docker/build-push-action@v5
        with:
          context: ./analytics-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics-service:${{ steps.meta.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Verify cluster connection
        run: kubectl cluster-info
      
      - name: Create namespace if not exists
        run: kubectl create namespace clickenrent --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create/Update secrets
        run: |
          kubectl create secret generic app-secrets \
            --from-literal=db-username="${{ secrets.DB_USERNAME }}" \
            --from-literal=db-password="${{ secrets.DB_PASSWORD }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --from-literal=jwt-expiration="${{ secrets.JWT_EXPIRATION }}" \
            --from-literal=jwt-refresh-expiration="${{ secrets.JWT_REFRESH_EXPIRATION }}" \
            --from-literal=redis-password="${{ secrets.REDIS_PASSWORD }}" \
            --from-literal=es-password="${{ secrets.ES_PASSWORD }}" \
            --from-literal=google-client-id="${{ secrets.GOOGLE_CLIENT_ID }}" \
            --from-literal=google-client-secret="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --from-literal=apple-team-id="${{ secrets.APPLE_TEAM_ID }}" \
            --from-literal=apple-client-id="${{ secrets.APPLE_CLIENT_ID }}" \
            --from-literal=apple-key-id="${{ secrets.APPLE_KEY_ID }}" \
            --from-literal=apple-private-key="${{ secrets.APPLE_PRIVATE_KEY }}" \
            --from-literal=multisafepay-api-key="${{ secrets.MULTISAFEPAY_API_KEY }}" \
            --from-literal=multisafepay-webhook-secret="${{ secrets.MULTISAFEPAY_WEBHOOK_SECRET }}" \
            --from-literal=service-auth-username="${{ secrets.SERVICE_AUTH_USERNAME }}" \
            --from-literal=service-auth-password="${{ secrets.SERVICE_AUTH_PASSWORD }}" \
            --from-literal=lock-encryption-key="${{ secrets.LOCK_ENCRYPTION_KEY }}" \
            --from-literal=azure-storage-connection-string="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --from-literal=mapbox-api-key="${{ secrets.MAPBOX_API_KEY }}" \
            --namespace clickenrent \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create image pull secret for GitHub Container Registry
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=${{ github.actor }}@users.noreply.github.com \
            --namespace clickenrent \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yml
          kubectl apply -f k8s/configmap.yml
          kubectl apply -f k8s/services/
          kubectl apply -f k8s/ingress.yml
      
      - name: Update image tags
        run: |
          kubectl set image deployment/eureka-server eureka-server=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/eureka-server:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/gateway gateway=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/gateway:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/auth-service auth-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/rental-service rental-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/rental-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/payment-service payment-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/payment-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/support-service support-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/support-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/notification-service notification-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/search-service search-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/search-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
          kubectl set image deployment/analytics-service analytics-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics-service:${{ steps.meta.outputs.sha_short }} -n clickenrent
      
      - name: Force restart to pick up new images
        run: kubectl rollout restart deployment -n clickenrent
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/eureka-server -n clickenrent --timeout=20m
          kubectl rollout status deployment/gateway -n clickenrent --timeout=20m
          kubectl rollout status deployment/auth-service -n clickenrent --timeout=20m
          kubectl rollout status deployment/rental-service -n clickenrent --timeout=20m
          kubectl rollout status deployment/payment-service -n clickenrent --timeout=20m
          kubectl rollout status deployment/support-service -n clickenrent --timeout=20m
          kubectl rollout status deployment/notification-service -n clickenrent --timeout=20m
          kubectl rollout status deployment/search-service -n clickenrent --timeout=20m
          kubectl rollout status deployment/analytics-service -n clickenrent --timeout=20m
      
      - name: Display deployment status
        if: always()
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n clickenrent -o wide
          echo ""
          echo "=== Services ==="
          kubectl get svc -n clickenrent
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n clickenrent
      
      - name: Debug failed pods
        if: failure()
        run: |
          echo "=== Recent Events ==="
          kubectl get events -n clickenrent --sort-by='.lastTimestamp' | tail -50
          echo ""
          for pod in $(kubectl get pods -n clickenrent --field-selector=status.phase!=Running -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "=== Describe pod: $pod ==="
            kubectl describe pod "$pod" -n clickenrent | tail -30
            echo ""
            echo "=== Logs: $pod ==="
            kubectl logs "$pod" -n clickenrent --tail=100 2>/dev/null || echo "No logs available"
            echo ""
          done
          for deploy in eureka-server gateway auth-service rental-service payment-service support-service notification-service search-service analytics-service; do
            STATUS=$(kubectl rollout status deployment/$deploy -n clickenrent --timeout=5s 2>&1 || true)
            if echo "$STATUS" | grep -q "error\|exceeded"; then
              echo "=== FAILED deployment: $deploy ==="
              kubectl describe deployment/$deploy -n clickenrent | tail -20
              echo ""
              for pod in $(kubectl get pods -n clickenrent -l app=$deploy -o jsonpath='{.items[*].metadata.name}'); do
                echo "--- Logs: $pod ---"
                kubectl logs "$pod" -n clickenrent --tail=80 2>/dev/null || echo "No logs available"
              done
              echo ""
            fi
          done
      
      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“¦ Image tag: ${{ steps.meta.outputs.sha_short }}"
          echo "ğŸŒ Access your services at: http://cnr.aybserve.com"
          echo "ğŸ“Š Eureka Dashboard: http://cnr.aybserve.com/eureka"
          echo "ğŸ“– Swagger UI: http://cnr.aybserve.com/swagger-ui.html"
