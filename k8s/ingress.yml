apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: clickenrent-ingress
  namespace: clickenrent
  annotations:
    # Use nginx ingress controller
    kubernetes.io/ingress.class: nginx
    
    # Disable SSL redirect until certificates are configured
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    
    # Enable CORS for application routes
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "http://cnr.aybserve.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type, Accept, Origin, X-Requested-With, Access-Control-Request-Method, Access-Control-Request-Headers"
    nginx.ingress.kubernetes.io/cors-expose-headers: "Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Credentials"
    
    # Request size limits
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # SSL certificate (cert-manager) - uncomment when cert-manager is installed
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # Configuration for monitoring path authentication and rewrites
    nginx.ingress.kubernetes.io/server-snippet: |
      location ~ ^/prometheus(/|$)(.*) {
        auth_basic "Authentication Required - Monitoring";
        auth_basic_user_file /etc/nginx/secrets/default-clickenrent-monitoring-basic-auth;
        rewrite ^/prometheus(/|$)(.*) /$2 break;
        proxy_pass http://upstream_balancer;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }
      
      location /grafana {
        auth_basic "Authentication Required - Monitoring";
        auth_basic_user_file /etc/nginx/secrets/default-clickenrent-monitoring-basic-auth;
        proxy_pass http://upstream_balancer;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }
spec:
  rules:
  - host: cnr.aybserve.com
    http:
      paths:
      # Monitoring: Prometheus (handled by server-snippet above)
      - path: /prometheus
        pathType: Prefix
        backend:
          service:
            name: prometheus
            port:
              number: 9090
      
      # Monitoring: Grafana (handled by server-snippet above)
      - path: /grafana
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
      
      # Route all other traffic through Gateway (MUST be last)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gateway
            port:
              number: 8080
